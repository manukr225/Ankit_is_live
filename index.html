<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cine-Verse Portal</title>
    <style>
        :root {
            --background-color: #f4f4f5; /* Light Gray */
            --text-color: #111827; /* Dark Gray */
            --border-color: #d1d5db; /* Lighter Gray */
            --primary-button-bg: #000000;
            --primary-button-text: #ffffff;
            --link-color: #3b82f6;
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* --- Page & Utility Classes --- */
        .page { display: none; flex-direction: column; min-height: 100vh; }
        .page.active { display: flex; }
        .hidden { display: none !important; }

        /* --- Login Portals --- */
        .portal-page {
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .portal-container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 2.5rem 2rem;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .portal-container h1 {
            text-align: center;
            margin: 0 0 1rem 0;
            font-size: 1.8rem;
            font-weight: 600;
        }
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .input-group input {
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
        }
        .input-group input:focus { outline: 2px solid var(--link-color); border-color: transparent; }
        .button {
            padding: 0.8rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        .button:hover { opacity: 0.9; }
        .btn-primary { background-color: var(--primary-button-bg); color: var(--primary-button-text); }
        .portal-switch-link, .portal-sub-link {
            text-align: center;
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.9rem;
        }
        .portal-switch-link span, .portal-sub-link span { color: var(--link-color); font-weight: 600; }
        .status-message { text-align: center; font-weight: bold; padding: 0.5rem; border-radius: 4px; }
        .status-message.error { color: #ef4444; }
        .status-message.success { color: #22c55e; }

        /* --- Main App Header --- */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background-color: #ffffff;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .search-bar { flex-grow: 1; margin: 0 1rem; }
        .search-bar input {
            width: 100%;
            padding: 0.6rem 1rem;
            background-color: #f4f4f5;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-color);
            font-size: 1rem;
        }
        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #e5e7eb;
            cursor: pointer;
        }
        .profile-icon svg { width: 24px; height: 24px; fill: var(--text-color); }

        /* --- Home Page --- */
        #movie-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; padding: 1rem; }
        .movie-card { cursor: pointer; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .movie-card-thumbnail { width: 100%; aspect-ratio: 16 / 9; object-fit: cover; }
        .movie-card-info { padding: 1rem; }
        .movie-card-info h3 { margin: 0; font-size: 1.2rem; }
        .movie-card-info p { margin: 0.25rem 0 0; color: #6b7280; }

        /* --- Movie Streaming Page --- */
        #streaming-page-content { padding: 1rem; }
        .video-player-container { width: 100%; aspect-ratio: 16 / 9; background-color: #000; margin-bottom: 1rem; }
        #video-player { width: 100%; height: 100%; }
        #movie-details h2 { margin-top: 0; }

        /* --- Admin Upload Page --- */
        #admin-upload-page .form-container {
            border: none;
            box-shadow: none;
            max-width: 600px;
            padding: 1rem;
        }
    </style>
</head>
<body>

    <!-- User Login Portal -->
    <div id="user-portal-page" class="page portal-page active">
        <div class="portal-container">
            <h1>User Portal</h1>
            <div class="input-group">
                <input type="email" id="user-email" placeholder="Email">
            </div>
            <div class="input-group">
                <input type="password" id="user-password" placeholder="Password">
            </div>
            <p id="user-error-message" class="status-message error hidden"></p>
            <button id="user-login-button" class="button btn-primary">Login</button>
            <p class="portal-sub-link" id="show-signup-link">Don't have an account? <span>Register</span></p>
            <p class="portal-switch-link" id="goto-admin-portal">Go to <span>Admin Portal</span></p>
        </div>
    </div>

    <!-- User Signup Portal -->
    <div id="signup-portal-page" class="page portal-page">
        <div class="portal-container">
            <h1>Create Account</h1>
            <div class="input-group">
                <input type="email" id="signup-email" placeholder="Email">
            </div>
            <div class="input-group">
                <input type="password" id="signup-password" placeholder="Password">
            </div>
            <p id="signup-error-message" class="status-message error hidden"></p>
            <button id="signup-button" class="button btn-primary">Register</button>
            <p class="portal-sub-link" id="show-login-link">Already have an account? <span>Login</span></p>
        </div>
    </div>

    <!-- Admin Login Portal -->
    <div id="admin-portal-page" class="page portal-page">
        <div class="portal-container">
            <h1>Admin Portal</h1>
            <div class="input-group">
                <input type="email" id="admin-email" placeholder="Email">
            </div>
            <div class="input-group">
                <input type="password" id="admin-password" placeholder="Password">
            </div>
            <p id="admin-error-message" class="status-message error hidden"></p>
            <button id="admin-login-button" class="button btn-primary">Login</button>
            <p class="portal-switch-link" id="goto-user-portal">Go to <span>User Portal</span></p>
        </div>
    </div>

    <!-- Home Page (for users) -->
    <div id="home-page" class="page">
        <header class="app-header">
            <div class="search-bar">
                <input type="search" placeholder="Search movies...">
            </div>
            <div id="profile-button" class="profile-icon">
                <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            </div>
        </header>
        <main id="movie-grid"></main>
    </div>
    
    <!-- Admin Upload Page -->
    <div id="admin-upload-page" class="page">
        <header class="app-header">
            <h1>Movie Upload</h1>
            <button id="admin-logout-button" class="button btn-primary">Logout</button>
        </header>
        <form id="upload-form" class="form-container">
            <div class="input-group">
                <label for="movie-title">Title</label>
                <input type="text" id="movie-title" required>
            </div>
            <div class="input-group">
                <label for="movie-year">Release Year</label>
                <input type="number" id="movie-year" required>
            </div>
            <div class="input-group">
                <label for="movie-desc">Description</label>
                <textarea id="movie-desc" rows="4" required></textarea>
            </div>
            <div class="input-group">
                <label for="movie-thumb">Thumbnail Image</label>
                <input type="file" id="movie-thumb" accept="image/*" required>
            </div>
            <div class="input-group">
                <label for="movie-video">Video File</label>
                <input type="file" id="movie-video" accept="video/*" required>
            </div>
            <p id="upload-status" class="status-message hidden"></p>
            <button type="submit" class="button btn-primary">Add Movie</button>
        </form>
    </div>

    <!-- Movie Streaming Page (for users) -->
    <div id="streaming-page" class="page">
        <!-- Header will be similar to home page, can be added if needed -->
        <main id="streaming-page-content">
            <button id="back-button" class="button"> &larr; Back to Home</button>
            <br><br>
            <div class="video-player-container">
                <video id="video-player" controls controlsList="nodownload"></video>
            </div>
            <div id="movie-details">
                <h2 id="movie-stream-title"></h2>
                <p id="movie-stream-description"></p>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <script>
        const firebaseConfig = {
            // TU CONFIGURACIÓN DE FIREBASE AQUÍ
            apiKey: "AIzaSyCYOhS9LFYDopNVRUhubPddHF4dyKZUs9g",
            authDomain: "cine-verse-8c12b.firebaseapp.com",
            databaseURL: "https://cine-verse-8c12b-default-rtdb.firebaseio.com",
            projectId: "cine-verse-8c12b",
            storageBucket: "cine-verse-8c12b.appspot.com",
            messagingSenderId: "232194416079",
            appId: "1:232194416079:web:5da38972f49f2d26d906ba",
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        const pages = {
            userPortal: document.getElementById('user-portal-page'),
            signupPortal: document.getElementById('signup-portal-page'),
            adminPortal: document.getElementById('admin-portal-page'),
            home: document.getElementById('home-page'),
            adminUpload: document.getElementById('admin-upload-page'),
            streaming: document.getElementById('streaming-page'),
        };

        function showPage(pageName) {
            Object.values(pages).forEach(page => page.classList.remove('active'));
            pages[pageName].classList.add('active');
        }
        
        // --- Portal Switching Logic ---
        document.getElementById('goto-admin-portal').addEventListener('click', () => showPage('adminPortal'));
        document.getElementById('goto-user-portal').addEventListener('click', () => showPage('userPortal'));
        document.getElementById('show-signup-link').addEventListener('click', () => showPage('signupPortal'));
        document.getElementById('show-login-link').addEventListener('click', () => showPage('userPortal'));

        // --- Auth State Change ---
        auth.onAuthStateChanged(user => {
            if (!user) {
                showPage('userPortal'); // If logged out, always return to user portal
            }
        });

        // --- User Portal Logic ---
        const userEmail = document.getElementById('user-email');
        const userPassword = document.getElementById('user-password');
        const userError = document.getElementById('user-error-message');
        document.getElementById('user-login-button').addEventListener('click', () => {
            auth.signInWithEmailAndPassword(userEmail.value, userPassword.value)
                .then(userCredential => {
                    loadMovies();
                    showPage('home');
                })
                .catch(error => {
                    userError.textContent = error.message;
                    userError.classList.remove('hidden');
                });
        });

        // --- Signup Portal Logic ---
        const signupEmail = document.getElementById('signup-email');
        const signupPassword = document.getElementById('signup-password');
        const signupError = document.getElementById('signup-error-message');
        document.getElementById('signup-button').addEventListener('click', () => {
            auth.createUserWithEmailAndPassword(signupEmail.value, signupPassword.value)
                .then(userCredential => {
                    loadMovies();
                    showPage('home'); // Log in and go home after signup
                })
                .catch(error => {
                    signupError.textContent = error.message;
                    signupError.classList.remove('hidden');
                });
        });

        // --- Admin Portal Logic ---
        const adminEmail = document.getElementById('admin-email');
        const adminPassword = document.getElementById('admin-password');
        const adminError = document.getElementById('admin-error-message');
        document.getElementById('admin-login-button').addEventListener('click', () => {
            auth.signInWithEmailAndPassword(adminEmail.value, adminPassword.value)
                .then(userCredential => {
                    // CRITICAL: Check for admin custom claim AFTER login
                    return userCredential.user.getIdTokenResult();
                })
                .then(idTokenResult => {
                    if (idTokenResult.claims.admin === true) {
                        showPage('adminUpload'); // Success! Go to upload page.
                    } else {
                        // Not an admin, show error and sign out.
                        auth.signOut();
                        adminError.textContent = "You do not have admin privileges.";
                        adminError.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    adminError.textContent = error.message;
                    adminError.classList.remove('hidden');
                });
        });

        // --- General App Logic ---
        document.getElementById('profile-button').addEventListener('click', () => auth.signOut());
        document.getElementById('admin-logout-button').addEventListener('click', () => auth.signOut());

        function loadMovies() {
            db.ref('movies').on('value', snapshot => {
                const movies = snapshot.val();
                pages.home.querySelector('#movie-grid').innerHTML = '';
                for (const movieId in movies) {
                    const movie = movies[movieId];
                    const movieCard = document.createElement('div');
                    movieCard.className = 'movie-card';
                    movieCard.innerHTML = `
                        <img src="${movie.thumbnailUrl}" alt="${movie.title}" class="movie-card-thumbnail">
                        <div class="movie-card-info">
                            <h3>${movie.title}</h3>
                            <p>${movie.releaseYear}</p>
                        </div>`;
                    movieCard.addEventListener('click', () => openStreamingPage(movie));
                    pages.home.querySelector('#movie-grid').appendChild(movieCard);
                }
            });
        }
        
        function openStreamingPage(movie) {
            pages.streaming.querySelector('#movie-stream-title').textContent = movie.title;
            pages.streaming.querySelector('#movie-stream-description').textContent = movie.description;
            const videoPlayer = pages.streaming.querySelector('#video-player');
            videoPlayer.src = movie.videoUrl;
            showPage('streaming');
        }

        document.getElementById('back-button').addEventListener('click', () => {
            pages.streaming.querySelector('#video-player').pause();
            pages.streaming.querySelector('#video-player').src = "";
            showPage('home');
        });

        // --- Admin Upload Form Logic ---
        const uploadForm = document.getElementById('upload-form');
        const uploadStatus = document.getElementById('upload-status');
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('movie-title').value;
            const year = document.getElementById('movie-year').value;
            const desc = document.getElementById('movie-desc').value;
            const thumbFile = document.getElementById('movie-thumb').files[0];
            const videoFile = document.getElementById('movie-video').files[0];
            if (!thumbFile || !videoFile) return;

            setStatus('Uploading files... Please wait.', 'info');
            
            try {
                const thumbRef = storage.ref(`thumbnails/${Date.now()}_${thumbFile.name}`);
                const thumbUrl = await (await thumbRef.put(thumbFile)).ref.getDownloadURL();
                setStatus('Thumbnail uploaded. Uploading video...', 'info');

                const videoRef = storage.ref(`videos/${Date.now()}_${videoFile.name}`);
                const videoUrl = await (await videoRef.put(videoFile)).ref.getDownloadURL();
                setStatus('Saving to database...', 'info');

                await db.ref('movies').push().set({
                    title, releaseYear: Number(year), description: desc, thumbnailUrl: thumbUrl, videoUrl
                });

                setStatus('Movie added successfully!', 'success');
                uploadForm.reset();
            } catch (error) {
                setStatus(`Error: ${error.message}`, 'error');
            }
        });

        function setStatus(message, type) {
            uploadStatus.textContent = message;
            uploadStatus.className = `status-message ${type}`;
            uploadStatus.classList.remove('hidden');
        }

    </script>
</body>
</html>
